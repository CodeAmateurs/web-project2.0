<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="auth.css">
    <link rel="stylesheet" href="modal.css">
    <title>Reset Password - MESMTF</title>
</head>
<body>
    <div class="auth-container register-container">
        <div class="auth-header">
            <i class="fas fa-laptop-medical"></i>
            <h1>MESMTF</h1>
        </div>
        <h2>Reset Your Password</h2>
        <p>Please enter and confirm your new password.</p>
        <form id="resetPasswordForm">
            <div class="form-group">
                <label for="password">New Password</label>
                <div class="password-wrapper">
                    <input type="password" id="password" name="password" required>
                    <i class="fas fa-eye-slash toggle-password"></i>
                </div>
                <!-- Reusing password strength indicator from registration -->
                <div id="password-strength-requirements">
                    <ul>
                        <li id="length">At least 8 characters</li>
                        <li id="lowercase">A lowercase letter</li>
                        <li id="uppercase">An uppercase letter</li>
                        <li id="number">A number</li>
                        <li id="special">A special character (e.g., !@#$%)</li>
                    </ul>
                </div>
            </div>
            <div class="form-group">
                <label for="confirmPassword">Confirm New Password</label>
                <div class="password-wrapper">
                    <input type="password" id="confirmPassword" name="confirmPassword" required>
                    <i class="fas fa-eye-slash toggle-password"></i>
                </div>
            </div>
            <button type="submit" class="btn">Reset Password</button>
        </form>
        <div class="extra-links">
            <p>Remembered your password? <a href="login.html">Login here</a></p>
        </div>
    </div>

    <script src="modal.js"></script>
    <script>
        // --- Password Strength Checker (reused from registration.html) ---
        const passwordInput = document.getElementById('password');
        const requirements = {
            length: document.getElementById('length'), lowercase: document.getElementById('lowercase'),
            uppercase: document.getElementById('uppercase'), number: document.getElementById('number'), special: document.getElementById('special')
        };
        let passwordIsValid = false;

        passwordInput.addEventListener('keyup', function() {
            const value = passwordInput.value;
            let validCount = 0;
            if (value.length >= 8) { requirements.length.classList.add('valid'); validCount++; } else { requirements.length.classList.remove('valid'); }
            if (/[a-z]/.test(value)) { requirements.lowercase.classList.add('valid'); validCount++; } else { requirements.lowercase.classList.remove('valid'); }
            if (/[A-Z]/.test(value)) { requirements.uppercase.classList.add('valid'); validCount++; } else { requirements.uppercase.classList.remove('valid'); }
            if (/[0-9]/.test(value)) { requirements.number.classList.add('valid'); validCount++; } else { requirements.number.classList.remove('valid'); }
            if (/[!@#$%^&*(),.?":{}|<>]/.test(value)) { requirements.special.classList.add('valid'); validCount++; } else { requirements.special.classList.remove('valid'); }
            passwordIsValid = validCount === 5;
        });

        // --- Reset Logic ---
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const email = urlParams.get('email');

            if (!email) {
                showModal('Invalid Link', 'The password reset link is invalid or has expired.', 'error', () => {
                    window.location.href = 'login.html';
                });
                return;
            }

            document.getElementById('resetPasswordForm').addEventListener('submit', function(event) {
                event.preventDefault();

                const newPassword = document.getElementById('password').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                if (!passwordIsValid) {
                    showModal('Weak Password', 'Please ensure your new password meets all the requirements.');
                    return;
                }

                if (newPassword !== confirmPassword) {
                    showModal('Error', 'Passwords do not match. Please try again.');
                    return;
                }

                let users = JSON.parse(localStorage.getItem('users')) || [];
                const userIndex = users.findIndex(user => user.email === email);

                if (userIndex > -1) {
                    // Update the user's password
                    users[userIndex].password = newPassword;
                    localStorage.setItem('users', JSON.stringify(users));

                    showModal('Success', 'Your password has been reset successfully. You will be redirected to the login page.', 'success', () => {
                        window.location.href = 'login.html';
                    });
                } else {
                    showModal('Error', 'An error occurred. Could not find user to update.', 'error');
                }
            });
        });

        // --- Toggle Password Visibility ---
        document.querySelectorAll('.toggle-password').forEach(toggle => {
            toggle.addEventListener('click', function() {
                const passwordField = this.previousElementSibling;
                const type = passwordField.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordField.setAttribute('type', type);
                this.classList.toggle('fa-eye');
                this.classList.toggle('fa-eye-slash');
            });
        });
    </script>
</body>
</html>